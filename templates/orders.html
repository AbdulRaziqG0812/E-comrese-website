<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Orders - AREEZ FRAGRANCE</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* 🌈 Background Animation */
body {
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
  color: #f8fafc;
  background-size: 400% 400%;
  animation: gradientShift 15s ease infinite;
  min-height: 100vh;
  overflow-x: hidden;
}
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* 🧭 Header */
header {
  text-align: center;
  padding: 30px 20px;
  color: #fff;
}
header h1 {
  font-size: 2.2em;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  background: linear-gradient(90deg, #00c6ff, #0072ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin: 0;
}

/* 🎯 Top Actions */
.top-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
  padding: 0 30px 20px;
}
.search-box {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255, 255, 255, 0.1);
  padding: 8px 12px;
  border-radius: 10px;
  backdrop-filter: blur(8px);
}
.search-box input {
  background: transparent;
  border: none;
  outline: none;
  color: #fff;
  padding: 8px;
  font-size: 15px;
  width: 250px;
}
.search-box input::placeholder {
  color: rgba(255, 255, 255, 0.6);
}
.search-box button {
  background: linear-gradient(90deg, #22c55e, #16a34a);
  border: none;
  color: white;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}
.search-box button:hover { transform: scale(1.05); }

.btn-home {
  background: linear-gradient(90deg, #facc15, #eab308);
  color: #000;
  padding: 8px 16px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s ease;
}
.btn-home:hover { transform: scale(1.05); }

/* 🧾 Table */
.table-container {
  margin: 0 30px;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border-radius: 14px;
  box-shadow: 0 4px 30px rgba(0,0,0,0.3);
  overflow-x: auto;
  padding: 10px;
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1300px;
}
th, td {
  padding: 12px 16px;
  text-align: center;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  font-size: 14px;
}
th {
  background: rgba(255,255,255,0.08);
  color: #93c5fd;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
tr:hover { background: rgba(255,255,255,0.08); transition: 0.2s; }

.status-dropdown {
  padding: 6px 10px;
  border-radius: 8px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}

/* 🪟 Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 999;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: #f9fafb;
  color: #111;
  padding: 25px;
  border-radius: 10px;
  max-width: 450px;
  width: 90%;
  position: relative;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
.modal-content h3 {
  margin-top: 0;
  color: #0f172a;
}
.close-btn {
  position: absolute;
  top: 10px; right: 10px;
  background: red;
  border: none;
  color: white;
  font-weight: bold;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  cursor: pointer;
}

/* 💰 Total Summary */
.total-summary {
  margin: 30px auto;
  text-align: center;
  background: rgba(255,255,255,0.08);
  padding: 16px 25px;
  border-radius: 12px;
  width: fit-content;
  font-size: 18px;
  color: #facc15;
  font-weight: 600;
  box-shadow: 0 3px 10px rgba(0,0,0,0.3);
}

/* 🔘 Pagination */
#pagination {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin: 20px 0;
}
.page-btn {
  background: rgba(255,255,255,0.15);
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}
.page-btn:hover {
  background: #38bdf8;
  transform: scale(1.1);
}
.page-btn.active {
  background: linear-gradient(90deg, #22c55e, #16a34a);
}
</style>
</head>

<body>
  <header>
    <h1>Admin Orders Dashboard</h1>
  </header>

  <div class="top-actions">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search orders by customer, city, or status...">
      <button onclick="filterOrders()"><i class="fa-solid fa-search"></i> Search</button>
    </div>
    <a href="{{ url_for('dashboard') }}" class="btn-home"><i class="fa-solid fa-house"></i> Home</a>
  </div>

  <div class="table-container">
    <table class="paginated-table" id="ordersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer</th>
          <th>Email</th>
          <th>Contact</th>
          <th>Country</th>
          <th>City</th>
          <th>Postal</th>
          <th>Address</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Items</th>
          <th>Status</th>
          <th>Created At</th>
          <th>Action</th> <!-- ✅ new column -->
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr>
          <td>{{ order.id }}</td>
          <td>{{ order.user_name }}</td>
          <td>{{ order.email }}</td>
          <td>{{ order.phone }}</td>
          <td>{{ order.country }}</td>
          <td>{{ order.city }}</td>
          <td>{{ order.postal }}</td>
          <td>{{ order.address }}</td>
          <td class="order-total">{{ order.total }}</td>
          <td>{{ order.payment_method }}</td>
          <td>
            <button class="btn-view" style="background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;padding:6px 10px;border-radius:6px;color:white;cursor:pointer;"
                    onclick='viewItems({{ order["items"] | tojson | safe }})'>
              <i class="fa-solid fa-eye"></i>
            </button>
          </td>
          <td>
            <select class="status-dropdown" onchange="updateStatus({{ order.id }}, this.value)">
              <option value="Pending" {% if order.status=='Pending' %}selected{% endif %}>Pending</option>
              <option value="Processing" {% if order.status=='Processing' %}selected{% endif %}>Processing</option>
              <option value="Shipped" {% if order.status=='Shipped' %}selected{% endif %}>Shipped</option>
              <option value="Completed" {% if order.status=='Completed' %}selected{% endif %}>Completed</option>
              <option value="Cancelled" {% if order.status=='Cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
          </td>
          <td>{{ order.created_at }}</td>
          <td>
            <button onclick="deleteOrder({{ order.id }})" 
              style="background:linear-gradient(90deg,#ef4444,#dc2626);border:none;padding:6px 10px;border-radius:6px;color:white;cursor:pointer;">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="14" style="color:#facc15;padding:18px;">No orders found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="total-summary">
    Total Sales: PKR <span id="totalSales">0</span>
  </div>
  <div id="pagination"></div>

  <!-- 🪟 Modal -->
  <div id="itemModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">×</button>
      <h3>Ordered Perfumes</h3>
      <div id="itemsList"></div>
    </div>
  </div>

<script>
function viewItems(items) {
  const container = document.getElementById('itemsList');
  container.innerHTML = "";
  if (!items || items.length === 0) {
    container.innerHTML = "<p>No items found in this order.</p>";
  } else {
    items.forEach(it => {
      container.innerHTML += `<p><strong>${it.name}</strong> — ${it.quantity} pcs @ PKR ${it.price}</p>`;
    });
  }
  document.getElementById('itemModal').style.display = 'flex';
}
function closeModal() { document.getElementById('itemModal').style.display = 'none'; }

function updateStatus(orderId, newStatus) {
  fetch(`/update_order_status/${orderId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status: newStatus })
  })
  .then(res => res.json())
  .then(data => alert(data.message))
  .catch(err => alert("Error updating status!"));
}

function deleteOrder(orderId) {
  if (!confirm("⚠️ Are you sure you want to delete this order?")) return;

  fetch(`/delete_order/${orderId}`, {
    method: "DELETE",
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if (data.success) {
      location.reload();
    }
  })
  .catch(() => alert("❌ Failed to delete order. Please try again."));
}


function calculateTotalSales() {
  const totals = document.querySelectorAll('.order-total');
  let totalSum = 0;
  totals.forEach(td => {
    if (td.closest('tr').style.display !== 'none') {
      const val = parseFloat(td.textContent) || 0;
      totalSum += val;
    }
  });
  document.getElementById('totalSales').textContent = totalSum.toLocaleString();
}

function filterOrders() {
  const filter = document.getElementById('searchInput').value.trim().toLowerCase();
  const rows = document.querySelectorAll('.paginated-table tbody tr');
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(filter) ? '' : 'none';
  });
  calculateTotalSales();
}

document.addEventListener("DOMContentLoaded", function () {
  const rowsPerPage = 10;
  const table = document.querySelector(".paginated-table");
  const tbody = table.querySelector("tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const pagination = document.getElementById("pagination");
  const totalPages = Math.ceil(rows.length / rowsPerPage);
  let currentPage = 1;

  function displayPage(page) {
    currentPage = page;
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    rows.forEach((r, i) => r.style.display = (i >= start && i < end) ? "" : "none");
    updatePagination();
    calculateTotalSales();
  }

  function updatePagination() {
    pagination.innerHTML = "";
    const prev = document.createElement("button");
    prev.innerHTML = "«";
    prev.disabled = currentPage === 1;
    prev.className = "page-btn";
    prev.onclick = () => displayPage(currentPage - 1);
    pagination.appendChild(prev);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.innerHTML = i;
      btn.className = "page-btn" + (i === currentPage ? " active" : "");
      btn.onclick = () => displayPage(i);
      pagination.appendChild(btn);
    }

    const next = document.createElement("button");
    next.innerHTML = "»";
    next.disabled = currentPage === totalPages;
    next.className = "page-btn";
    next.onclick = () => displayPage(currentPage + 1);
    pagination.appendChild(next);
  }

  displayPage(1);
});
</script>
</body>
</html>
